#!/usr/bin/env bash
set -euo pipefail
# https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html

BUILD_DIR="${1}"
CACHE_DIR="${2}"
DEPS_DIR="${3}"
DEPS_IDX="${4}"

BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))

if [ -f "${BUILD_DIR}/runtime.txt" ]
then
    GRAFANA_VERSION=$((grep -v '^#' "${BUILD_DIR}/runtime.txt" || true) | head -n1)
    if [ -z "${GRAFANA_VERSION}" ]
    then
        echo "ERROR> runtime.txt found but no version specified!"
        exit 1
    fi
fi
source ${BUILDPACK_DIR}/parameters.sh

if [ "$(echo -e "${GRAFANA_MIN_VERSION}\n${GRAFANA_VERSION}" | sort -V | head -n1)" == "${GRAFANA_MIN_VERSION}" ]
then 
    # Greater than or equal to 6.0.0"
    echo "-----> Requesting grafana ${GRAFANA_VERSION}"
else
    echo "ERROR> Grafana version ${GRAFANA_VERSION} not supported by this buildpack"
    exit 1
fi

if [ -f "${CACHE_DIR}/grafana-${GRAFANA_VERSION}.tar.gz" ]
then
    echo "-----> Using grafana ${GRAFANA_VERSION} from cache"
else
    echo "-----> Downloading Grafana: ${GRAFANA_DOWNLOAD_URL}"
    if ! wget -nv "${GRAFANA_DOWNLOAD_URL}" -O "${CACHE_DIR}/grafana-${GRAFANA_VERSION}.tar.gz" 2>&1 | sed 's/^/       /'
    then
        echo "ERROR> Grafana version ${GRAFANA_VERSION} not found, URL=${GRAFANA_DOWNLOAD_URL}"
        exit 1
    fi
fi

if [ -f "${CACHE_DIR}/cloud_sql_proxy-${CLOUDSQL_PROXY_VERSION}.bin" ]
then
    echo "-----> Using cloudsql proxy ${CLOUDSQL_PROXY_VERSION} from cache"
else
    echo "-----> Downloading cloudsql proxy: ${CLOUDSQL_PROXY_DOWNLOAD_URL}"
    if ! wget -nv "${CLOUDSQL_PROXY_DOWNLOAD_URL}" -O "${CACHE_DIR}/cloud_sql_proxy-${CLOUDSQL_PROXY_VERSION}.bin" 2>&1 | sed 's/^/       /'
    then
        echo "ERROR> cloudsql proxy version ${GRAFANA_VERSION} not found, URL=${CLOUDSQL_PROXY_DOWNLOAD_URL}"
        exit 1
    fi
fi

echo "-----> Installing Grafana"
mkdir -p "${GRAFANA_DIR}"
tar -zxf "${CACHE_DIR}/grafana-${GRAFANA_VERSION}.tar.gz" -C "${GRAFANA_DIR}" --strip-components 1
chmod +x ${GRAFANA_DIR}/bin/grafana-*

echo "-----> Installing Cloudsql Proxy"
mkdir -p "${SQLPROXY_DIR}"
cp "${CACHE_DIR}/cloud_sql_proxy-${CLOUDSQL_PROXY_VERSION}.bin" "${SQLPROXY_DIR}/cloud_sql_proxy"
chmod +x ${SQLPROXY_DIR}/cloud_sql_proxy

echo "-----> Symlinking Grafana properties and defining default configuration settings"
rm -rf "${GRAFANA_DIR}/conf/provisioning"
cp ${BUILDPACK_DIR}/defaults.ini "${GRAFANA_DIR}/conf/"
mkdir -p "$BUILD_DIR/.profile.d"
cat <<EOF > "$BUILD_DIR/.profile.d/0010_grafana.sh"
export GRAFANA_VERSION=${GRAFANA_VERSION}
export CLOUDSQL_PROXY_VERSION=${CLOUDSQL_PROXY_VERSION}

export GRAFANA_ROOT="/home/vcap/deps/${DEPS_IDX}/grafana"
export SQLPROXY_ROOT="/home/vcap/deps/${DEPS_IDX}/cloud_sql_proxy"

# Avoid overriding these vars by end user vars
export GF_PATHS_PLUGINS="/home/vcap/app/plugins"
export GF_PATHS_PROVISIONING="/home/vcap/app"
export GF_PATHS_LOGS="/home/vcap/logs"
export GF_PATHS_DATA="/home/vcap/tmp"
export GF_ENTERPRISE_LICENSE_PATH="/home/vcap/app/license"
EOF

